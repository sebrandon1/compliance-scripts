name: Test Compliance Operator

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'

jobs:
  test-compliance:
    runs-on: ubuntu-latest
    # Only run on main branch, not from forks, and not from dependabot
    if: github.repository_owner == 'sebrandon1' && github.actor != 'dependabot[bot]'
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Verify CRC_PULL_SECRET is set
        env:
          CRC_PULL_SECRET: ${{ secrets.CRC_PULL_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${CRC_PULL_SECRET}" ]; then
            echo "CRC_PULL_SECRET secret is required but not set. Add it in repository or organization secrets."
            exit 1
          fi

      - name: Setup quick-ocp cluster
        uses: palmsoftware/quick-ocp@v0.0.23
        with:
          ocpPullSecret: $OCP_PULL_SECRET
          bundleCache: true
          waitForOperatorsReady: true
        env:
          OCP_PULL_SECRET: ${{ secrets.CRC_PULL_SECRET }}

      - name: Run compliance validation
        run: make test-compliance
